name: Changelog
description: Build changelog text from pr_info JSON and changelog configuration.
inputs:
  configuration-path:
    description: Path to changelog.yml configuration.
    required: false
    default: ""
  pr-info-path:
    description: Path to pr_info JSON generated by version-resolver.
    required: true
outputs:
  changelog:
    description: Rendered changelog markdown.
    value: ${{ steps.build.outputs.changelog }}
  changes:
    description: Category-grouped changes section before template wrapping.
    value: ${{ steps.build.outputs.changes }}
  pull-requests:
    description: Comma-separated PR numbers included in changelog.
    value: ${{ steps.build.outputs.pull-requests }}
runs:
  using: composite
  steps:
    - name: Install Python dependencies
      shell: bash
      run: |
        python3 -m pip install --quiet pyyaml

    - name: Resolve changelog configuration path
      id: config
      shell: bash
      run: |
        set -euo pipefail

        if [ -z "${{ inputs.configuration-path }}" ]; then
          CONFIG_PATH="${{ github.action_path }}/changelog.yml"
        else
          CONFIG_PATH="${{ inputs.configuration-path }}"
        fi

        [ -f "$CONFIG_PATH" ] || { echo "Config not found: $CONFIG_PATH"; exit 1; }
        [ -f "${{ inputs.pr-info-path }}" ] || { echo "pr_info not found: ${{ inputs.pr-info-path }}"; exit 1; }

        echo "config-path=$CONFIG_PATH" >> "$GITHUB_OUTPUT"

    - name: Build changelog
      id: build
      shell: bash
      run: |
        set -euo pipefail

        python3 "${{ github.action_path }}/build_changelog.py" \
          --config-path "${{ steps.config.outputs.config-path }}" \
          --pr-info-path "${{ inputs.pr-info-path }}" \
          --output-format line >> "$GITHUB_OUTPUT"
