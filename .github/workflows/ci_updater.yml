name: CI updater

on:
  workflow_call:
    inputs:
      create-pr:
        description: Create or update a PR with template changes.
        type: boolean
        required: false
        default: true
      automerge:
        description: Enable auto-merge (squash) on the updater PR.
        type: boolean
        required: false
        default: false
      pr-branch:
        description: Branch name used for template updates.
        type: string
        required: false
        default: chore/update-ci-template
      pr-title:
        description: Pull request title.
        type: string
        required: false
        default: "chore: update CI template"
      commit-message:
        description: Commit message for template updates.
        type: string
        required: false
        default: "chore: apply CI template update"
    secrets:
      token:
        description: Optional token override for checkout, push, and PR operations.
        required: false
    outputs:
      changed:
        description: Whether Copier produced changes.
        value: ${{ jobs.update.outputs.changed }}
      branch:
        description: Branch name used for the update commit.
        value: ${{ jobs.update.outputs.branch }}
      pr-url:
        description: URL for the update PR, if created.
        value: ${{ jobs.update.outputs.pr-url }}

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: ci-updater-${{ github.repository }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.pr.outputs.pull-request-number != '' }}
      branch: ${{ steps.pr.outputs.pull-request-branch }}
      pr-url: ${{ steps.pr.outputs.pull-request-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.token || github.token }}

      - name: Install Copier
        shell: bash
        run: |
          python3 -m pip install --quiet copier

      - name: Apply template updates
        id: apply
        shell: bash
        env:
          ANSWERS_FILE: .copier-answers.ci.yml
        run: |
          set -euo pipefail
          if [ ! -f "$ANSWERS_FILE" ]; then
            echo "No $ANSWERS_FILE found; skipping Copier update."
            echo "ran=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ran=true" >> "$GITHUB_OUTPUT"
          copier update --trust -a "$ANSWERS_FILE" -A --vcs-ref HEAD --defaults

      - name: Create or update PR
        id: pr
        if: ${{ inputs.create-pr && github.event.pull_request.head.repo.full_name == github.repository}}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.token || github.token }}
          base: ${{ github.event.repository.default_branch }}
          branch: ${{ inputs.pr-branch }}
          commit-message: ${{ inputs.commit-message }}
          title: ${{ inputs.pr-title }}
          body: ${{ inputs.commit-message }}
          labels: ${{ inputs.automerge == 'true' && 'automerge' || '' }}
