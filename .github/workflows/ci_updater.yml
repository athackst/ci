name: CI updater

on:
  workflow_call:
    inputs:
      template-ref:
        description: Template ref to apply (branch, tag, or SHA).
        type: string
        required: false
        default: main
      create-pr:
        description: Create or update a PR with template changes.
        type: boolean
        required: false
        default: true
      push-changes:
        description: Push update commit to the remote branch.
        type: boolean
        required: false
        default: true
      pr-branch:
        description: Branch name used for template updates.
        type: string
        required: false
        default: chore/update-ci-template
      pr-title:
        description: Pull request title.
        type: string
        required: false
        default: "chore: update CI template"
      commit-message:
        description: Commit message for template updates.
        type: string
        required: false
        default: "chore: apply CI template update"
    secrets:
      token:
        description: Optional token override for checkout, push, and PR operations.
        required: false
    outputs:
      changed:
        description: Whether Copier produced changes.
        value: ${{ jobs.update.outputs.changed }}
      branch:
        description: Branch name used for the update commit.
        value: ${{ jobs.update.outputs.branch }}
      pr-url:
        description: URL for the update PR, if created.
        value: ${{ jobs.update.outputs.pr-url }}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ci-updater-${{ github.repository }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      branch: ${{ steps.meta.outputs.branch }}
      pr-url: ${{ steps.pr.outputs.pr-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.token || github.token }}

      - name: Install Copier
        shell: bash
        run: |
          python3 -m pip install --quiet copier

      - name: Apply template updates
        id: apply
        shell: bash
        env:
          TEMPLATE_REF: ${{ inputs.template-ref }}
          ANSWERS_FILE: .copier-answers.ci.yml
        run: |
          set -euo pipefail
          if [ ! -f "$ANSWERS_FILE" ]; then
            echo "No $ANSWERS_FILE found; skipping Copier update."
            echo "ran=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ran=true" >> "$GITHUB_OUTPUT"
          copier update --trust -a "$ANSWERS_FILE" -A --vcs-ref "$TEMPLATE_REF" --defaults

      - name: Detect changes
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve metadata
        id: meta
        shell: bash
        env:
          PR_BRANCH: ${{ inputs.pr-branch }}
          CREATE_PR: ${{ inputs.create-pr }}
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          BRANCH="$PR_BRANCH"
          if [ "$CREATE_PR" != "true" ]; then
            if [ -n "${HEAD_REF}" ]; then
              BRANCH="${HEAD_REF}"
            else
              BRANCH="${REF_NAME}"
            fi
          fi

          if [ -z "$BRANCH" ] || [ "$BRANCH" = "HEAD" ]; then
            echo "Unable to resolve a valid branch name for push."
            exit 1
          fi
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Commit and push changes
        if: ${{ steps.detect.outputs.changed == 'true' && inputs.push-changes }}
        shell: bash
        env:
          BRANCH: ${{ steps.meta.outputs.branch }}
          CREATE_PR: ${{ inputs.create-pr }}
          COMMIT_MESSAGE: ${{ inputs.commit-message }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ "$CREATE_PR" = "true" ]; then
            git checkout -B "$BRANCH"
          fi

          git add -A
          git commit -m "$COMMIT_MESSAGE"
          if [ "$CREATE_PR" = "true" ]; then
            git push --force-with-lease origin "HEAD:$BRANCH"
          else
            git push origin "HEAD:$BRANCH"
          fi

      - name: Create or find PR
        id: pr
        if: ${{ steps.detect.outputs.changed == 'true' && inputs.push-changes && inputs.create-pr }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.token || github.token }}
          BRANCH: ${{ steps.meta.outputs.branch }}
          PR_TITLE: ${{ inputs.pr-title }}
          COMMIT_MESSAGE: ${{ inputs.commit-message }}
        run: |
          set -euo pipefail

          PR_URL="$(gh pr list --state open --head "$BRANCH" --json url --jq '.[0].url // empty')"
          if [ -z "$PR_URL" ]; then
            PR_URL="$(gh pr create --head "$BRANCH" --title "$PR_TITLE" --body "$COMMIT_MESSAGE")"
          fi

          echo "pr-url=$PR_URL" >> "$GITHUB_OUTPUT"
