name: CI Updater

on:
  workflow_call:
    inputs:
      create-pr:
        description: Create or update a PR with template changes.
        type: boolean
        required: false
        default: true
      automerge:
        description: Enable auto-merge (squash) on the updater PR.
        type: boolean
        required: false
        default: false
      pr-branch:
        description: Branch name used for template updates.
        type: string
        required: false
        default: chore/update-ci-template
      pr-title:
        description: Pull request title.
        type: string
        required: false
        default: "chore: update CI template"
      commit-message:
        description: Commit message for template updates.
        type: string
        required: false
        default: "chore: apply CI template update"
    secrets:
      token:
        description: Optional token override for checkout, push, and PR operations.
        required: false
    outputs:
      changed:
        description: Whether create-pull-request created or updated a PR (typically indicates template changes were applied).
        value: ${{ jobs.update.outputs.changed }}
      branch:
        description: Branch name returned by create-pull-request, if a PR was created or updated.
        value: ${{ jobs.update.outputs.branch }}
      pr-url:
        description: URL for the update PR, if created or updated.
        value: ${{ jobs.update.outputs.pr-url }}

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.pr.outputs.pull-request-number != '' }}
      branch: ${{ steps.pr.outputs.pull-request-branch }}
      pr-url: ${{ steps.pr.outputs.pull-request-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.token || github.token }}

      - name: Install Copier
        shell: bash
        run: |
          python3 -m pip install --quiet copier

      - name: Apply template updates
        id: apply
        shell: bash
        env:
          ANSWERS_FILE: .copier-answers.ci.yml
        run: |
          set -euo pipefail
          if [ ! -f "$ANSWERS_FILE" ]; then
            echo "No $ANSWERS_FILE found; skipping Copier update."
            echo "ran=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ran=true" >> "$GITHUB_OUTPUT"
          copier update --trust -a "$ANSWERS_FILE" -A --vcs-ref HEAD --defaults

      - name: Create or update PR
        id: pr
        if: ${{ inputs.create-pr }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.token || github.token }}
          base: ${{ github.event.repository.default_branch }}
          branch: ${{ inputs.pr-branch }}
          commit-message: ${{ inputs.commit-message }}
          title: ${{ inputs.pr-title }}
          body: ${{ inputs.commit-message }}
          labels: ${{ inputs.automerge && 'automerge' || '' }}

      - name: Workflow summary
        if: ${{ always() }}
        shell: bash
        env:
          APPLY_RAN: ${{ steps.apply.outputs.ran || 'false' }}
          CREATE_PR_REQUESTED: ${{ inputs.create-pr }}
          AUTOMERGE_REQUESTED: ${{ inputs.automerge }}
          PR_BRANCH_INPUT: ${{ inputs.pr-branch }}
          PR_OPERATION: ${{ steps.pr.outputs.pull-request-operation }}
          PR_NUMBER: ${{ steps.pr.outputs.pull-request-number }}
          PR_URL: ${{ steps.pr.outputs.pull-request-url }}
          PR_BRANCH: ${{ steps.pr.outputs.pull-request-branch }}
        run: |
          set -euo pipefail

          {
            echo "### CI Updater"
            echo ""

            if [ "${APPLY_RAN}" != "true" ]; then
              echo ":grey_exclamation: No update attempted (missing \`.copier-answers.ci.yml\`)."
            elif [ -n "${PR_URL}" ]; then
              echo ":white_check_mark: PR created or updated successfully."
              echo ""
              echo "pr-operation: \`${PR_OPERATION:-unknown}\`"
              echo "pr-number: \`${PR_NUMBER}\`"
              echo "pr-branch: \`${PR_BRANCH:-$PR_BRANCH_INPUT}\`"
              echo "pr-url: ${PR_URL}"
            elif [ "${CREATE_PR_REQUESTED}" = "true" ]; then
              echo ":x: No PR created or updated."
              echo ""
              echo "pr-operation: \`${PR_OPERATION:-none}\`"
            else
              echo "PR creation disabled by input."
            fi

            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
