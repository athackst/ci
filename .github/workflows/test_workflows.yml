name: Test workflows

on:
  pull_request:

jobs:
  workflow-lint:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: actionlint
        uses: raven-actions/actionlint@v2
        with:
          files: ".github/workflows/*.yml"

  workflow-pr-bot:
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/pr_bot.yml
    secrets: inherit

  workflow-pr-labeler:
    permissions:
      contents: read
      pull-requests: write
    # This is intentionally pointed at ./workflows/ to validate whether
    # GitHub accepts reusable workflows outside .github/workflows.
    uses: ./.github/workflows/pr_labeler.yml
    secrets: inherit

  workflow-mkdocs-site:
    permissions:
      contents: write
      pages: write
      id-token: write
    uses: ./.github/workflows/mkdocs_site.yml
    secrets: inherit
    with:
      pages: false
      artifact-name: github-pages-mkdocs-test
      htmlproofer-ignore-urls: |
        /^https://github.com/athackst/ci$/

  workflow-mkdocs-site-verify:
    permissions:
      contents: read
    needs: [workflow-mkdocs-site]
    runs-on: ubuntu-latest
    steps:
      - name: Download mkdocs artifact
        uses: actions/download-artifact@v7
        with:
          name: github-pages-mkdocs-test
          path: ./artifact

      - name: Verify mkdocs artifact contents
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p site
          if [ -f ./artifact/artifact.tar ]; then
            tar --directory site -xvf ./artifact/artifact.tar
          else
            TAR_FILE="$(find ./artifact -maxdepth 2 -type f -name '*.tar' | head -n1)"
            if [ -n "$TAR_FILE" ]; then
              tar --directory site -xvf "$TAR_FILE"
            else
              cp -R ./artifact/. site/
            fi
          fi

          test -f site/index.html
          grep -q "<html" site/index.html

  workflow-jekyll-site:
    permissions:
      contents: write
      pages: write
      id-token: write
    uses: ./.github/workflows/jekyll_site.yml
    secrets: inherit
    with:
      path: tests/fixtures/jekyll_site
      pages: false
      artifact-name: github-pages-jekyll-test
      htmlproofer-ignore-urls: |
        /^https://github.com/athackst/ci$/

  workflow-jekyll-site-verify:
    permissions:
      contents: read
    needs: [workflow-jekyll-site]
    runs-on: ubuntu-latest
    steps:
      - name: Download Jekyll artifact
        uses: actions/download-artifact@v7
        with:
          name: github-pages-jekyll-test
          path: ./artifact

      - name: Verify Jekyll artifact contents
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p _site
          if [ -f ./artifact/artifact.tar ]; then
            tar --directory _site -xvf ./artifact/artifact.tar
          else
            TAR_FILE="$(find ./artifact -maxdepth 2 -type f -name '*.tar' | head -n1)"
            if [ -n "$TAR_FILE" ]; then
              tar --directory _site -xvf "$TAR_FILE"
            else
              cp -R ./artifact/. _site/
            fi
          fi

          test -f _site/index.html
          grep -q "Jekyll Fixture" _site/index.html

  workflow-release-draft:
    permissions:
      contents: write
      pull-requests: read
    uses: ./.github/workflows/release_draft.yml
    secrets: inherit
    with:
      name: test-release-${{ github.run_id }}-${{ github.run_attempt }}
      tag-name: ci-workflow-draft-${{ github.run_id }}-${{ github.run_attempt }}

  workflow-release-draft-verify-and-cleanup:
    permissions:
      contents: write
    needs: [workflow-release-draft]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Verify and cleanup workflow release draft
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_ID: ${{ needs.workflow-release-draft.outputs.id }}
          EXPECTED_NAME: ${{ needs.workflow-release-draft.outputs.name }}
          EXPECTED_TAG: ${{ needs.workflow-release-draft.outputs.tag-name }}
        run: |
          set -euo pipefail

          if [ -z "${RELEASE_ID:-}" ]; then
            echo "No release id returned; nothing to verify or clean up."
            exit 0
          fi

          RELEASE_JSON="$(gh api "repos/${{ github.repository }}/releases/${RELEASE_ID}")"
          ACTUAL_NAME="$(jq -r '.name' <<< "$RELEASE_JSON")"
          ACTUAL_TAG="$(jq -r '.tag_name' <<< "$RELEASE_JSON")"
          ACTUAL_DRAFT="$(jq -r '.draft' <<< "$RELEASE_JSON")"

          [ "$ACTUAL_DRAFT" = "true" ] || { echo "Expected draft release"; exit 1; }
          [ "$ACTUAL_NAME" = "$EXPECTED_NAME" ] || { echo "Name mismatch"; exit 1; }
          [ "$ACTUAL_TAG" = "$EXPECTED_TAG" ] || { echo "Tag mismatch"; exit 1; }

          gh api -X DELETE "repos/${{ github.repository }}/releases/${RELEASE_ID}" || true

  actions-success:
    needs:
      - workflow-lint
      - workflow-pr-bot
      - workflow-pr-labeler
      - workflow-mkdocs-site-verify
      - workflow-jekyll-site-verify
      - workflow-release-draft-verify-and-cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate upstream job results
        shell: bash
        run: |
          echo "All workflow tests passed."
