name: Test workflows

on:
  pull_request:

jobs:
  workflow-lint:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: actionlint
        uses: raven-actions/actionlint@v2
        with:
          files: ".github/workflows/*.yml"

  workflow-pr-bump:
    permissions:
      contents: write
      pull-requests: write
    uses: ./.github/workflows/pr_bump.yml
    with:
      bump-script: tests/fixtures/pr_bump.sh
      push-branch: ci-test/pr-bump-${{ github.run_id }}-${{ github.run_attempt }}
    secrets: inherit

  workflow-pr-bump-verify-and-cleanup:
    permissions:
      contents: write
      pull-requests: read
    needs: [workflow-pr-bump]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Verify pr_bump workflow result
        shell: bash
        env:
          RESULT: ${{ needs.workflow-pr-bump.result }}
        run: |
          set -euo pipefail
          [ "$RESULT" = "success" ] || {
            echo "workflow-pr-bump result was: $RESULT"
            exit 1
          }

      - name: Checkout PR head branch
        uses: actions/checkout@v6
        with:
          ref: ci-test/pr-bump-${{ github.run_id }}-${{ github.run_attempt }}
          fetch-depth: 1

      - name: Verify pr_bump fixture output
        shell: bash
        env:
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          set -euo pipefail

          OUT_FILE="tests/fixtures/pr_bump_output.txt"
          [ -f "$OUT_FILE" ] || {
            echo "Missing pr_bump fixture output: $OUT_FILE"
            exit 1
          }

          grep -q "^run_id=${RUN_ID}$" "$OUT_FILE"
          grep -q "^run_attempt=${RUN_ATTEMPT}$" "$OUT_FILE"
          grep -q '^from_ref=' "$OUT_FILE"
          grep -q '^resolved_version=' "$OUT_FILE"
          grep -q '^major_version=' "$OUT_FILE"
          grep -q '^minor_version=' "$OUT_FILE"
          grep -q '^patch_version=' "$OUT_FILE"

          RESOLVED_VERSION="$(sed -n 's/^resolved_version=//p' "$OUT_FILE")"
          VERSION_PARTS="$(sed -n 's/^version_parts=//p' "$OUT_FILE")"
          [ -n "$RESOLVED_VERSION" ] || {
            echo "resolved_version was empty"
            cat "$OUT_FILE"
            exit 1
          }
          [ "$RESOLVED_VERSION" = "$VERSION_PARTS" ] || {
            echo "version_parts did not match resolved_version"
            cat "$OUT_FILE"
            exit 1
          }

          {
            echo "### PR bump fixture output"
            echo ""
            cat "$OUT_FILE"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Delete pr_bump test branch
        if: ${{ always() }}
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          TEST_BRANCH: ci-test/pr-bump-${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euo pipefail
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/heads/${TEST_BRANCH}" || true

  workflow-mkdocs-site:
    permissions:
      contents: write
      pages: write
      id-token: write
    uses: ./.github/workflows/mkdocs_site.yml
    secrets: inherit
    with:
      pages: false
      artifact-name: github-pages-mkdocs-test
      htmlproofer-ignore-urls: |
        /^https://github.com/athackst/ci$/

  workflow-mkdocs-site-verify:
    permissions:
      contents: read
    needs: [workflow-mkdocs-site]
    runs-on: ubuntu-latest
    steps:
      - name: Download mkdocs artifact
        uses: actions/download-artifact@v7
        with:
          name: github-pages-mkdocs-test
          path: ./artifact

      - name: Verify mkdocs artifact contents
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p site
          if [ -f ./artifact/artifact.tar ]; then
            tar --directory site -xvf ./artifact/artifact.tar
          else
            TAR_FILE="$(find ./artifact -maxdepth 2 -type f -name '*.tar' | head -n1)"
            if [ -n "$TAR_FILE" ]; then
              tar --directory site -xvf "$TAR_FILE"
            else
              cp -R ./artifact/. site/
            fi
          fi

          test -f site/index.html
          grep -q "<html" site/index.html

  workflow-jekyll-site:
    permissions:
      contents: write
      pages: write
      id-token: write
    uses: ./.github/workflows/jekyll_site.yml
    secrets: inherit
    with:
      path: tests/fixtures/jekyll_site
      pages: false
      artifact-name: github-pages-jekyll-test
      htmlproofer-ignore-urls: |
        /^https://github.com/athackst/ci$/

  workflow-jekyll-site-verify:
    permissions:
      contents: read
    needs: [workflow-jekyll-site]
    runs-on: ubuntu-latest
    steps:
      - name: Download Jekyll artifact
        uses: actions/download-artifact@v7
        with:
          name: github-pages-jekyll-test
          path: ./artifact

      - name: Verify Jekyll artifact contents
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p _site
          if [ -f ./artifact/artifact.tar ]; then
            tar --directory _site -xvf ./artifact/artifact.tar
          else
            TAR_FILE="$(find ./artifact -maxdepth 2 -type f -name '*.tar' | head -n1)"
            if [ -n "$TAR_FILE" ]; then
              tar --directory _site -xvf "$TAR_FILE"
            else
              cp -R ./artifact/. _site/
            fi
          fi

          test -f _site/index.html
          grep -q "Jekyll Fixture" _site/index.html

  workflow-release-draft:
    permissions:
      contents: write
      pull-requests: read
    uses: ./.github/workflows/release_drafter.yml
    secrets: inherit
    with:
      name: test-release-${{ github.run_id }}-${{ github.run_attempt }}
      tag-name: ci-workflow-draft-${{ github.run_id }}-${{ github.run_attempt }}

  workflow-release-draft-verify-and-cleanup:
    permissions:
      contents: write
    needs: [workflow-release-draft]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Verify and cleanup workflow release draft
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_ID: ${{ needs.workflow-release-draft.outputs.id }}
          EXPECTED_NAME: ${{ needs.workflow-release-draft.outputs.name }}
          EXPECTED_TAG: ${{ needs.workflow-release-draft.outputs.tag-name }}
        run: |
          set -euo pipefail

          if [ -z "${RELEASE_ID:-}" ]; then
            echo "No release id returned; nothing to verify or clean up."
            exit 0
          fi

          RELEASE_JSON="$(gh api "repos/${{ github.repository }}/releases/${RELEASE_ID}")"
          ACTUAL_NAME="$(jq -r '.name' <<< "$RELEASE_JSON")"
          ACTUAL_TAG="$(jq -r '.tag_name' <<< "$RELEASE_JSON")"
          ACTUAL_DRAFT="$(jq -r '.draft' <<< "$RELEASE_JSON")"

          [ "$ACTUAL_DRAFT" = "true" ] || { echo "Expected draft release"; exit 1; }
          [ "$ACTUAL_NAME" = "$EXPECTED_NAME" ] || { echo "Name mismatch"; exit 1; }
          [ "$ACTUAL_TAG" = "$EXPECTED_TAG" ] || { echo "Tag mismatch"; exit 1; }

          gh api -X DELETE "repos/${{ github.repository }}/releases/${RELEASE_ID}" || true

  workflow-ci-updater:
    permissions:
      contents: write
      pull-requests: write
      actions: write
    uses: ./.github/workflows/ci_updater.yml
    secrets: inherit
    with:
      create-pr: true

  workflow-ci-updater-verify:
    permissions:
      contents: read
    needs: [workflow-ci-updater]
    runs-on: ubuntu-latest
    steps:
      - name: Verify ci_updater outputs
        shell: bash
        env:
          CHANGED: ${{ needs.workflow-ci-updater.outputs.changed }}
          BRANCH: ${{ needs.workflow-ci-updater.outputs.branch }}
          PR_URL: ${{ needs.workflow-ci-updater.outputs.pr-url }}
        run: |
          set -euo pipefail

          [ "$CHANGED" = "true" ] || [ "$CHANGED" = "false" ] || {
            echo "Invalid changed output: $CHANGED"
            exit 1
          }
          if [ "$CHANGED" = "true" ]; then
            [ -n "$BRANCH" ] || {
              echo "Missing branch output when changed=true"
              exit 1
            }
            [ "$BRANCH" != "HEAD" ] || {
              echo "Invalid branch output: HEAD"
              exit 1
            }
            [ -n "$PR_URL" ] || {
              echo "Missing pr-url output when changed=true"
              exit 1
            }
          fi

          {
            echo "### CI updater outputs"
            echo ""
            echo "- changed: \`$CHANGED\`"
            echo "- branch: \`$BRANCH\`"
            echo "- pr-url: \`$PR_URL\`"
            echo ""
            if [ "$CHANGED" != "true" ]; then
              echo "_No PR created/updated (likely no template changes)._"
              echo ""
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  workflows-success:
    needs:
      - workflow-lint
      - workflow-pr-bump-verify-and-cleanup
      - workflow-mkdocs-site-verify
      - workflow-jekyll-site-verify
      - workflow-release-draft-verify-and-cleanup
      - workflow-ci-updater-verify
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate upstream job results
        shell: bash
        run: |
          echo "All workflow tests passed."
