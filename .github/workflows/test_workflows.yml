name: Test workflows

on:
  workflow_dispatch:
  pull_request:

jobs:
  workflow-pr-labeler:
    permissions:
      contents: read
      pull-requests: write
    # This is intentionally pointed at ./workflows/ to validate whether
    # GitHub accepts reusable workflows outside .github/workflows.
    uses: ./.github/workflows/pr_labeler.yml
    secrets: inherit

  workflow-mkdocs-site:
    permissions:
      contents: write
      pages: write
      id-token: write
    uses: ./.github/workflows/mkdocs_site.yml
    secrets: inherit
    with:
      pages: false
      htmlproofer-ignore-urls: |
        /^https://github.com/athackst/ci$/

  workflow-release-draft:
    permissions:
      contents: write
      pull-requests: read
    uses: ./.github/workflows/release_draft.yml
    secrets: inherit
    with:
      name: test-release-${{ github.run_id }}-${{ github.run_attempt }}
      tag-name: ci-workflow-draft-${{ github.run_id }}-${{ github.run_attempt }}

  workflow-release-draft-verify-and-cleanup:
    permissions:
      contents: write
    needs: [workflow-release-draft]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Verify and cleanup workflow release draft
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_ID: ${{ needs.workflow-release-draft.outputs.id }}
          EXPECTED_NAME: ${{ needs.workflow-release-draft.outputs.name }}
          EXPECTED_TAG: ${{ needs.workflow-release-draft.outputs.tag-name }}
        run: |
          set -euo pipefail

          if [ -z "${RELEASE_ID:-}" ]; then
            echo "No release id returned; nothing to verify or clean up."
            exit 0
          fi

          RELEASE_JSON="$(gh api "repos/${{ github.repository }}/releases/${RELEASE_ID}")"
          ACTUAL_NAME="$(jq -r '.name' <<< "$RELEASE_JSON")"
          ACTUAL_TAG="$(jq -r '.tag_name' <<< "$RELEASE_JSON")"
          ACTUAL_DRAFT="$(jq -r '.draft' <<< "$RELEASE_JSON")"

          [ "$ACTUAL_DRAFT" = "true" ] || { echo "Expected draft release"; exit 1; }
          [ "$ACTUAL_NAME" = "$EXPECTED_NAME" ] || { echo "Name mismatch"; exit 1; }
          [ "$ACTUAL_TAG" = "$EXPECTED_TAG" ] || { echo "Tag mismatch"; exit 1; }

          gh api -X DELETE "repos/${{ github.repository }}/releases/${RELEASE_ID}" || true

  actions-success:
    needs:
      - workflow-pr-labeler
      - workflow-mkdocs-site
      - workflow-release-draft
      - workflow-release-draft-verify-and-cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate upstream job results
        shell: bash
        run: |
          echo "All workflow tests passed."
