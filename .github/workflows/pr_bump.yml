name: PR Bump

on:
  workflow_call:
    inputs:
      bump-script:
        description: Optional script path to run after version resolution.
        type: string
        required: false
        default: ""
      push-branch:
        description: Optional branch override for pushing bump commits (defaults to PR head branch).
        type: string
        required: false
        default: ""
    outputs:
      changed:
        description: Whether the bump script produced changes that were committed and pushed.
        value: ${{ jobs.pr-bump.outputs.changed }}
      version:
        description: Resolved version from the version resolver action, if any.
        value: ${{ jobs.pr-bump.outputs.resolved-version }}
    secrets:
      token:
        description: Optional token override for labeling, version resolution, and automerge.
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  pr-bump:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.bump.outputs.changed || 'false' }}
      resolved-version: ${{ steps.version.outputs.resolved-version || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.token || github.token }}

      - name: Resolve version metadata
        id: version
        if: ${{ inputs.bump-script != ''}}
        uses: athackst/ci/actions/version-resolver@main
        with:
          gh-token: ${{ secrets.token || github.token }}

      - name: Run bump script
        id: bump
        if: ${{ inputs.bump-script != '' }}
        shell: bash
        env:
          HEAD_REF: ${{ github.head_ref }}
          PUSH_BRANCH: ${{ inputs.push-branch }}
          FROM_REF: ${{ steps.version.outputs.from-ref }}
          RESOLVED_VERSION: ${{ steps.version.outputs.resolved-version }}
          MAJOR_VERSION: ${{ steps.version.outputs.major-version }}
          MINOR_VERSION: ${{ steps.version.outputs.minor-version }}
          PATCH_VERSION: ${{ steps.version.outputs.patch-version }}
          PR_INFO_PATH: ${{ steps.version.outputs.pr-info-path }}
        run: |
          set -euo pipefail

          SCRIPT_PATH="${{ inputs.bump-script }}"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "Bump script not found: $SCRIPT_PATH"
            exit 1
          fi

          bash "$SCRIPT_PATH"

          if [ -z "$(git status --porcelain)" ]; then
            echo "Bump script produced no changes."
            echo "changed=false" | tee -a "$GITHUB_OUTPUT"
            {
              echo "changed-files<<EOF"
              echo ""
              echo "EOF"
            } | tee -a "$GITHUB_OUTPUT"
            exit 0
          fi

          git add -A

          git add -A
          CHANGED_FILES="$(git diff --cached --name-only)"

          TARGET_BRANCH="$PUSH_BRANCH"
          if [ -z "$TARGET_BRANCH" ]; then
            TARGET_BRANCH="$HEAD_REF"
          fi
          if [ -z "$TARGET_BRANCH" ] || [ "$TARGET_BRANCH" = "HEAD" ]; then
            echo "Unable to resolve a valid target branch for bump commit push."
            exit 1
          fi

          {
            echo "changed=true"
            echo "target-branch=$TARGET_BRANCH"
            echo "changed-files<<EOF"
            printf '%s\n' "$CHANGED_FILES"
            echo "EOF"
          } | tee -a "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: apply automated version bump"
          git push origin "HEAD:refs/heads/${TARGET_BRANCH}"

      - name: Build PR bump comment body
        id: bump-comment
        if: ${{ github.event_name == 'pull_request' && steps.bump.outputs.changed == 'true' }}
        shell: bash
        env:
          TARGET_BRANCH: ${{ steps.bump.outputs.target-branch || '' }}
          RESOLVED_VERSION: ${{ steps.version.outputs.resolved-version || '' }}
          CHANGED_FILES: ${{ steps.bump.outputs.changed-files || '' }}
        run: |
          set -euo pipefail
          {
            echo "marker=<!-- ci:pr-bump -->"
            echo "body<<EOF"
            echo "<!-- ci:pr-bump -->"
            printf '%s' "Applied automated version bump commit"
            if [ -n "${RESOLVED_VERSION}" ]; then
              printf " for \`%s\`" "${RESOLVED_VERSION}"
            fi
            if [ -n "${TARGET_BRANCH}" ]; then
              printf " on branch \`%s\`" "${TARGET_BRANCH}"
            fi
            echo "."
            if [ -n "${CHANGED_FILES}" ]; then
              echo
              echo "Changed files:"
              echo '```text'
              printf '%s\n' "${CHANGED_FILES}"
              echo '```'
            fi
            echo "EOF"
          } | tee -a "$GITHUB_OUTPUT"

      - name: Find existing PR bump comment
        id: find-bump-comment
        if: ${{ github.event_name == 'pull_request' && steps.bump.outputs.changed == 'true' }}
        uses: peter-evans/find-comment@v4
        with:
          token: ${{ secrets.token || github.token }}
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: ${{ steps.bump-comment.outputs.marker }}

      - name: Create or update PR bump comment
        if: ${{ github.event_name == 'pull_request' && steps.bump.outputs.changed == 'true' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.token || github.token }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-bump-comment.outputs.comment-id }}
          body: ${{ steps.bump-comment.outputs.body }}
          edit-mode: replace

      - name: Workflow summary
        if: ${{ always() }}
        shell: bash
        env:
          ACTOR: ${{ github.actor }}
          BUMP_SCRIPT: ${{ inputs.bump-script }}
          CHANGED: ${{ steps.bump.outputs.changed || 'false' }}
          TARGET_BRANCH: ${{ steps.bump.outputs.target-branch || '' }}
          CHANGED_FILES: ${{ steps.bump.outputs.changed-files || '' }}
          FROM_REF: ${{ steps.version.outputs.from-ref }}
          RESOLVED_VERSION: ${{ steps.version.outputs.resolved-version }}
          MAJOR_VERSION: ${{ steps.version.outputs.major-version }}
          MINOR_VERSION: ${{ steps.version.outputs.minor-version }}
          PATCH_VERSION: ${{ steps.version.outputs.patch-version }}
        run: |
          set -euo pipefail

          {
            echo "### PR Bump"
            echo ""

            if [ -z "${BUMP_SCRIPT}" ]; then
              echo ":information_source: No bump script configured; workflow performed no bump."
            elif [ -n "${RESOLVED_VERSION}" ]; then
              if [ "${CHANGED}" = "true" ]; then
                echo ":white_check_mark: Bump commit was created and pushed."
              else
                echo ":information_source: Bump script ran but produced no changes."
              fi
              echo ""
              echo "from-ref: \`${FROM_REF}\`"
              echo "target-branch: \`${TARGET_BRANCH}\`"
              echo "resolved-version: \`${RESOLVED_VERSION}\`"
              echo "version-parts: \`${MAJOR_VERSION}.${MINOR_VERSION}.${PATCH_VERSION}\`"
              if [ -n "${CHANGED_FILES}" ]; then
                echo ""
                echo "changed-files:"
                echo '```text'
                printf '%s\n' "${CHANGED_FILES}"
                echo '```'
              fi
            else
              echo ":grey_question: Version metadata was not resolved."
            fi

            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
