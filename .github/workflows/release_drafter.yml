name: Release Draft
on:
  workflow_call:
    inputs:
      name:
        description: Optional explicit release name override.
        type: string
        required: false
        default: ""
      tag-name:
        description: Optional explicit release tag override.
        type: string
        required: false
        default: ""
    secrets:
      token:
        description: Optional token override used to create or update draft release.
        required: false

    outputs:
      id:
        description: Draft release id.
        value: ${{ jobs.release-draft.outputs.id }}
      name:
        description: Draft release name.
        value: ${{ jobs.release-draft.outputs.name }}
      tag-name:
        description: Draft release tag name.
        value: ${{ jobs.release-draft.outputs.tag-name }}
      html-url:
        description: Draft release html url.
        value: ${{ jobs.release-draft.outputs.html-url }}
      upload-url:
        description: Draft release upload url.
        value: ${{ jobs.release-draft.outputs.upload-url }}
      resolved-version:
        description: Resolved semantic version used for defaults.
        value: ${{ jobs.release-draft.outputs.resolved-version }}
      changelog:
        description: Generated changelog markdown body.
        value: ${{ jobs.release-draft.outputs.changelog }}

jobs:
  release-draft:
    permissions:
      contents: write
      pull-requests: read
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.release.outputs.id }}
      name: ${{ steps.release.outputs.name }}
      tag-name: ${{ steps.release.outputs.tag-name }}
      html-url: ${{ steps.release.outputs.html-url }}
      upload-url: ${{ steps.release.outputs.upload-url }}
      resolved-version: ${{ steps.version.outputs.resolved-version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve version metadata
        id: version
        uses: athackst/ci/actions/version-resolver@main
        with:
          gh-token: ${{ secrets.token || github.token }}

      - name: Build changelog
        id: changelog
        uses: athackst/ci/actions/changelog@main
        with:
          pr-info-path: ${{ steps.version.outputs.pr-info-path }}

      - name: Resolve release name and tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          RESOLVED_VERSION="${{ steps.version.outputs.resolved-version }}"

          TAG_NAME="${{ inputs.tag-name }}"
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="v${RESOLVED_VERSION}"
          fi

          RELEASE_NAME="${{ inputs.name }}"
          if [ -z "$RELEASE_NAME" ]; then
            RELEASE_NAME="Release v${RESOLVED_VERSION}"
          fi

          echo "tag-name=$TAG_NAME" | tee -a "$GITHUB_OUTPUT"
          echo "name=$RELEASE_NAME" | tee -a "$GITHUB_OUTPUT"

      - name: Create or update draft release
        id: release
        uses: athackst/ci/actions/release-draft@main
        with:
          token: ${{ secrets.token || github.token }}
          name: ${{ steps.meta.outputs.name }}
          tag-name: ${{ steps.meta.outputs.tag-name }}
          changelog: ${{ steps.changelog.outputs.changelog }}
