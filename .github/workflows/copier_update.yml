name: Copier Update

on:
  pull_request:
    paths:
      - "copier.yml"
      - "template/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: copier-update-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  copier-update:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}
          token: ${{ secrets.CI_BOT_TOKEN || github.token }}

      - name: Install Copier
        shell: bash
        run: |
          python3 -m pip install --quiet copier

      - name: Apply Copier template
        id: copier
        shell: bash
        run: |
          set -euo pipefail
          copier copy --trust --defaults --overwrite . .

      - name: Commit generated workflow updates
        id: commit
        shell: bash
        env:
          HEAD_REF: ${{ github.head_ref || github.ref_name }}
        run: |
          set -euo pipefail

          mapfile -t TEMPLATE_FILES < <(find template/.github/workflows -maxdepth 1 -type f -name '*.jinja' | sort)
          GENERATED_FILES=()
          for template_file in "${TEMPLATE_FILES[@]}"; do
            generated_name="$(basename "$template_file" .jinja)"
            GENERATED_FILES+=(".github/workflows/${generated_name}")
          done

          if [ "${#GENERATED_FILES[@]}" -eq 0 ]; then
            echo "No template workflow files found under template/.github/workflows."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            {
              echo "updated-files<<EOF"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git add -- "${GENERATED_FILES[@]}"

          STAGED_FILES="$(git diff --cached --name-only)"

          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            {
              echo "updated-files<<EOF"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            echo "updated-files<<EOF"
            printf '%s\n' "$STAGED_FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update generated workflows from Copier template"
          git push origin "HEAD:refs/heads/${HEAD_REF}"

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Build Copier update comment body
        id: copier-comment
        if: ${{ github.event_name == 'pull_request' && steps.commit.outputs.changed == 'true' }}
        shell: bash
        env:
          UPDATED_FILES: ${{ steps.commit.outputs.updated-files || '' }}
        run: |
          set -euo pipefail
          {
            echo "marker=<!-- ci:copier-update -->"
            echo "body<<EOF"
            echo "<!-- ci:copier-update -->"
            echo "Applied Copier-generated workflow updates."
            if [ -n "${UPDATED_FILES}" ]; then
              echo
              echo "Updated files:"
              echo '```text'
              printf '%s\n' "${UPDATED_FILES}"
              echo '```'
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Copier update comment
        if: ${{ github.event_name == 'pull_request' && steps.commit.outputs.changed == 'true' }}
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.CI_BOT_TOKEN || github.token }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.copier-comment.outputs.body }}

      - name: Workflow summary
        if: ${{ always() }}
        shell: bash
        env:
          UPDATED_FILES: ${{ steps.commit.outputs.updated-files || '' }}
        run: |
          set -euo pipefail
          {
            echo "### Copier Update"
            echo ""
            if [ -n "${UPDATED_FILES}" ]; then
              echo "Updated generated workflow files:"
              echo ""
              echo '```text'
              printf '%s\n' "${UPDATED_FILES}"
              echo '```'
            else
              echo "No generated workflow file changes to commit."
            fi
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
